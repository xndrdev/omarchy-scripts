#!/usr/bin/env bash
set -euo pipefail

# Funktion checkt ob das Laptop offen oder zu ist (returns 0=open, 1=closed)
is_lid_open() {
  local statefile="/proc/acpi/button/lid/LID0/state"
  if [[ -f "$statefile" ]]; then
    grep -q 'open' "$statefile"
  else
    # Fallback: Angenommen offen, falls keine Info verfügbar
    return 0
  fi
}

STATE="${1:-}"   # "open" | "close" | "check"
[[ "$STATE" == "open" || "$STATE" == "close" || "$STATE" == "check" ]] || {
  echo "Usage: $0 {open|close|check}" >&2
  exit 1
}

if [[ "$STATE" == "check" ]]; then
  # Beim Start kurz warten, damit Hyprland vollständig initialisiert ist
  sleep 2
  if is_lid_open; then
    STATE="open"
  else
    STATE="close"
  fi
fi

# Funktion aktiviert alle verfügbaren Monitore als Fallback
enable_all_monitors() {
  local monitors=$(hyprctl monitors 2>/dev/null | grep -E "^Monitor" | awk '{print $2}' | tr -d ':')
  local config_file="$HOME/.config/hypr/monitors.conf"
  local tmp_file=$(mktemp)
  
  # Bestehende Config ohne monitor-Zeilen übernehmen
  if [[ -f "$config_file" ]]; then
    grep -Ev '^\s*monitor\s*=' "$config_file" > "$tmp_file" || true
  else
    : > "$tmp_file"
  fi
  
  # Alle Monitore mit preferred aktivieren
  for monitor in $monitors; do
    sed -i "1i monitor = $monitor, preferred, auto" "$tmp_file"
  done
  
  # Atomar schreiben
  mv "$tmp_file" "$config_file"
  
  # Hyprland neu laden
  hyprctl reload >/dev/null 2>&1 || true
}

# Profil je nach Deckelzustand laden
if [[ "$STATE" == "open" ]]; then
  # Deckel ist offen - Laptop-Profil laden
  if hyprmon -profile laptop >/dev/null 2>&1; then
    command -v notify-send >/dev/null 2>&1 && \
      notify-send "Hyprland Monitors" "Laptop-Deckel offen: Laptop-Profil geladen"
  else
    # Fallback: Alle Monitore aktivieren
    enable_all_monitors
    command -v notify-send >/dev/null 2>&1 && \
      notify-send "Hyprland Monitors" "Laptop-Profil konnte nicht geladen werden - alle Monitore aktiviert"
  fi
else
  # Deckel ist zu - nichts tun (oder anderes Profil, falls gewünscht)
  # hyprmon -profile work >/dev/null 2>&1 || true
  command -v notify-send >/dev/null 2>&1 && \
    notify-send "Hyprland Monitors" "Laptop-Deckel zu"
fi